const asianDramas = [
    {
        id: 1,
        name: `Eternal Love of Dream`,
        year:  2020,
        country: `China`,
        genres: 'Romance, Wuxia, Drama, Fantasy',
        description: `Queen of Qing Qiu, Bai Feng Jiu, is the only red nine-tailed fox in the world. One day, Feng Jiu is attacked by a savage beast while seeking cultivation in the mountains and is saved by the first emperor of Heaven, Dong Hua. Grateful and feeling indebted, Feng Jiu accompanies Dong Hua to vanquish the Demon Lord. 
        <br><br> 
        As the two spend time together, Feng Jiu realizes her gratitude towards Dong Hua has slowly evolved into love. Unfortunately, Dong Hua has long forgotten what love is. Although the coldest hearts can melt with time, will countless lifetimes be sufficient to bring these two hearts together?`,
        cast: `Dilraba Dilmurat, Gao Wei Guang, Li Dong Heng, Lawrence Wang`,
        image: [`img/eternal-love-of-dream.webp`,
                `img/eternal-love-of-dream2.webp`,
                `img/eternal-love-of-dream3.webp`],
    },
    {
        id: 2,
        name: `F4 Thailand: Boys Over Flowers`,
        year:  2021,
        country: `Thailand`,
        genres: 'Comedy, Romance, Youth, Drama',
        description: `Gorya is a simple girl who works at a flower shop. She passes an exam and gets accepted into a prestigious and luxurious school attended by the wealthy. The school is ruled by an elite clique known as the F4 consisting of four rich, handsome and spoiled boys. Gorya is the only one who stands up to their bullying, leaving all the boys in awe, especially Thyme, the group's leader. Almost instantly smitten by Gorya, Thyme romantically pursues her but she has no interest in him due to first impressions. She instead falls for his best friend Ren, However, Ren is still in love with his childhood love Mira. In all the chaos of school, Gorya can't help but find herself falling for Thyme because of his generosity to her and her family and his change of character.`,
        cast: `Tu Tontawan Tantivejakul, Bright Vachirawit Chivaaree, Dew Jirawat Sutivanichsak, Win Metawin Opas-iamkajorn, Nani Hirunkit Changkham `,
        image: [`img/f4-thailand.webp`,
                `img/f4-thailand2.webp`,
                `img/f4-thailand3.webp`],
    },
    {
        id: 3,
        name: `Flex X Cop`,
        year:  2024,
        country: `South Korea`,
        genres: 'Action, Thriller, Mystery, Comedy',
        description: `Jin Yi Soo has everything in life. Being a third-generation conglomerate, he never requires others assistance. However, things start changing when he gets entangled in a case.
        <br><br> 
        Jin Yi Soo joins the violent investigative team at the Kangha Police Station that specializes in catching robbers. He aims to use his wealth and personal connections to his advantage. He works under Detective Lee Kang Hyun. Kang Hyun is dedicated and a smooth-talker and doesn't care for Yi Soo's presence when they begin working as partners.`,
        cast: `Ahn Bo Hyun, Park Ji Hyun, Kang Sang Jun, Kim Shin Bi, Jang Hyun Sung, Kwak Shi Yang`,
        image: [`img/flex-x-cop.webp`,
                `img/flex-x-cop2.webp`, 
                `img/flex-x-cop3.webp`],
    },
    {
        id: 4,
        name: `Falling into Your Smile `,
        year:  2021,
        country: `China`,
        genres: 'Comedy, Romance, Youth, Sports',
        description: `In the ultra-competitive world of e-sports, the all-male ZGDX OPL team is second to none. Armies of adoring female fans follow the team wherever it goes. But when one of the team’s star players suffers a hand injury, the tall, handsome, and notoriously hard-to-please ZGDX captain Lu Si Cheng will not be rushed into choosing a replacement.
        <br><br> 
        The petite, lollipop-loving Tong Yao, meanwhile, is a budding amateur gamer – obsessed with OPL. Her skills are exceptional, but she is of the firm belief that in the male-dominated world of pro gaming, love is a big no-no – even though her own ex-boyfriend was a gamer. When the ZGDX team manager learns of her skills, he contacts her, thinking that recruiting her as the scene’s first female player will help score a major PR coup. Lu Si Cheng is dismissive of her initially, but eventually agrees to accept her as a substitute – a move that polarizes the team’s fanbase. But as they start to get to know one another better, could a closer bond begin to form between them?`,
        cast: `Xu Kai, Cheng Xiao, Zhai Xiao Wen, Yao Chi, Rachel Wang, Zhou Yi Ran`,
        image: [`img/falling-into-your-smile.webp`, 
                `img/falling-into-your-smile2.webp`, 
                `img/falling-into-your-smile3.webp`],
    },
    {
        id: 5,
        name: `You Are My Glory`,
        year:  2021,
        country: `China`,
        genres: 'Comedy, Romance, Life, Drama',
        description: `A story that follows an aerospace engineer Yu Tu and the shining star Qiao Jing Jing. A decision is made to start gaming in order to save her endorsement deal brings her face to face with an old crush. As they grow closer, the two forge ahead to become each other's glory. Being a well-known celebrity, Qiao Jing Jing has to keep up with appearances in order to maintain her multi-faceted image. Alas, one starts to crack when someone leaks a video of her playing an online game and being terrible at it which is completely inconsistent with the image she has created for herself as the game's ambassador. Thus, she joins a gaming competition to prove her skills and to prevent herself from losing her endorsements.
        <br><br> 
        Qiao Jing Jing decides to use all of her free time towards improving her game and her decision leads her to reconnect with her old high school classmate, Yu Tu, whom she once had a crush on. He was a legend at their school, outstanding in everything that he does, while Qiao Jing Jing was just your average girl. Yu Tu went on to become an aerospace engineer who is also an expert gamer. It seems that the online game brought them together once more so she asks him to become her gaming coach. `,
        cast: `Yang Yang, Dilraba Dilmurat, Pan Yue Ming, Hu Ke, Wang Yan Lin, Sun Ya Li`,
        image: [`img/glory.webp`, 
                `img/glory2.webp`,
                `img/glory3.webp`],
    },
    {
        id: 6,
        name: `Flash Marriage`,
        year:  2022,
        country: `Thailand`,
        genres: 'Comedy, Romance',
        description: `After a one-night stand with Pokpong, a male dancer Lalin meets at her friend's bachelorette party, Lalin decides to hire him. The job is simple; Pokpong is to marry Lalin for a few months so she can prove to her family that she deserves to be the heiress of her father's company.
        <br><br> 
        Things start to change when Lalin discovers there is more to Pokpong, than just a one-night stand.`,
        cast: `Tono Phakin Khamwilaisak, Pooklook Fonthip Watcharatrakul, May Pitchanart Sakhakorn, Akk Akarat Nimitchai, Suzana Renaud, Tonon Wongboon`,
        image: [`img/flash-marriage.webp`, 
                `img/flash-marriage2.webp`, 
                `img/flash-marriage3.webp`],
    },
    {
        id: 7,
        name: `She and Her Perfect Husband`,
        year:  2022,
        country: `China`,
        genres: 'Law, Romance',
        description: `Lawyer Qin Shi is focused on her career but is rushed into the marriage by her parents. The top law firm "Cheng and Hui" is recruiting lawyers specializing in family affairs, and one of the requirements is to be married. Qin Wen Yu, Qin Shi's second brother, secretly changed Qin Shi's marital status to "married" without her knowledge, creating a fictional husband for her. Not knowing anything, Qin Shi is employed by the firm.
        <br><br> 
        Her outstanding performance earned the approval of the founder Lao Jin. During a gathering with partners, Lao Jin recommends Qin Shi to be the legal counsel for the Association of Women Entrepreneurs. It is only then Qin Shi realizes that she is purportedly married. 
        <br><br>
        Qin Shi decides to clarify the situation to Lao Jin, but at this moment, her "husband", Yang Hua, appears. He's forced by his mother to come for a matchmaking session with Qin Shi's competitor. Feeling resentful over his mother's forceful actions, he forms an alliance with Qin Shi to benefit from the situation. They hit it off immediately and impulsively decide to register their marriage. However, both their parents sense something wrong with the situation.
        <br><br>
        Qin Shi's ex-boyfriend suddenly joins the law firm, and while facing numerous crises, Qin Shi and Yang Hua begin to have feelings for each other.`,
        cast: `Xu Kai, Cheng Xiao, Zhai Xiao Wen, Yao Chi, Rachel Wang, Zhou Yi Ran`,
        image: [`img/perfect-husband.webp`, 
                `img/perfect-husband2.webp`, 
                `img/perfect-husband3.webp`],
    },
    {
        id: 8,
        name: `Healer`,
        year:  2014,
        country: `South Korea`,
        genres: 'Action, Thriller, Mystery, Romance',
        description: `Seo Jung Hoo is a special kind of night courier, known only as "Healer" by his clients. For the right price and with the help of a genius hacker, he gets his clients whatever they want, as long as it doesn't involve murder. His latest job leads him to a second-rate tabloid writer, Chae Young Shin, and the successful reporter, Kim Moon Ho. He begins to uncover the mystery of his own shared past with the two reporters, thus putting them all in danger.`,
        cast: `Xu Kai, Cheng Xiao, Zhai Xiao Wen, Yao Chi, Rachel Wang, Zhou Yi Ran`,
        image: [`img/healer.webp`, 
                `img/healer2.webp`, 
                `img/healer3.webp`],
    },
    {
        id: 9,
        name: `Innocent Lies`,
        year:  2022,
        country: `Thailand`,
        genres: 'Romance, Drama',
        description: `AGun is Parin's best friend who owned a luxury hotel. They become business partners after Gun offers to sell some of his hotel's shares to Parin. Gun is also married, however, his marriage is rocky and he and his wife are going through a divorce.
        <br><br> 
        What's difficult is that his wife is determined to get her hands on the "Twilight Resort" through their divorce settlement. However, Gun has some incriminating evidence against her which can cost her this case. 
        <br>
        When his wife finds out about the evidence, she decides to offer Wimala a job to steal that evidence from Gun. 
        <br>
        Wimala refuses to do such a low deed at first, however, Gun's wife convinces her after showing Wimala the bruises and marks she has on her body from Gun's bondage play and abuse. Seeing the bruise and since she also needs money for her mother's treatment, Wimala agrees to this job — completely convinced that Gun is an abusive and evil person.`,
        cast: `Xu Kai, Cheng Xiao, Zhai Xiao Wen, Yao Chi, Rachel Wang, Zhou Yi Ran`,
        image: [`img/innocent-lies.webp`, 
                `img/innocent-lies2.webp`, 
                `img/innocent-lies3.webp`],
    },
    {
        id: 10,
        name: `Lawless Lawyer`,
        year:  2018,
        country: `South Korea`,
        genres: 'Action, Thriller, Law, Romance',
        description: `Whatever gets the job done. Bong Sang Pil grew up living the gangster life, full of tough physical fights and evading the law. When his mother dies a tragic death, he is determined to avenge her death. Sang Pil becomes a lawyer and begins to go after people with absolute power who think they are beyond the law. With the cunning and skills from his previous life, Sang Pil uses both his fists and legal loopholes to amass an impressive winning record.
        <br><br> 
        Ha Jae Yi is a young lawyer who believes the law is sacred and fights for justice. But her license gets suspended when she hits a judge over an unjust ruling during a trial. Jae Yi ends up going to work for Sang Pil so that she can continue to pay off her father’s debts. When Sang Pil and Jae Yi get involved in a case that involves Cha Moon Sook, a senior judge who wields a great deal of power, and Ahn Oh Joo, a former gangster who is now the CEO of a corporation, can they figure out a way to beat the most powerful people in the city at a very dangerous game?`,
        cast: `Xu Kai, Cheng Xiao, Zhai Xiao Wen, Yao Chi, Rachel Wang, Zhou Yi Ran`,
        image: [`img/lawless-lawyer.webp`, 
                `img/lawless-lawyer2.webp`, 
                `img/lawless-lawyer3.webp`],
    },
    {
        id: 11,
        name: `Massaya`,
        year:  2017,
        country: `Thailand`,
        genres: 'Historical, Romance, Drama, Melodrama',
        description: `Massaya's father, who is the adoptive son of the Rattanamahasarn family, is kicked out, along with his wife and child, of the Rattanamahasarn family for marrying her mother, who's believed to be a "low class" Malay woman. Both parents have passed away early she was brought up by her maternal grandfather.
        <br><br> 
        Years later. Massaya grows up as a free-spirited, boyish and a little crude woman. Head of Rattanamahasarn family, Massaya's grandmother, the adoptive mother of Massaya's father, feeling sad and guilty about the past, orders her grandson Lak to bring back Massaya.
        <br>
        Massaya after coming back to Rattanamahasarn family feels like an outcast with overbearing rules, etiquette and a family who looks down on her. She can only feel comfortable with Lak; while she constantly faces bullying from her cousins and their mother.`,
        cast: `Xu Kai, Cheng Xiao, Zhai Xiao Wen, Yao Chi, Rachel Wang, Zhou Yi Ran`,
        image: [`img/massaya.webp`, 
                `img/massaya2.webp`, 
                `img/massaya3.webp`],
    },
    {
        id: 12,
        name: `Queen of Tears`,
        year:  2024,
        country: `South Korea`,
        genres: 'Comedy, Romance, Life, Drama',
        description: `Baek Hyun Woo, who is the pride of the village of Yongduri, is the legal director of the conglomerate Queens Group, while chaebol heiress Hong Hae In is the “queen” of Queens Group’s department stores.
        <br><br> 
        “Queen of Tears” will tell the miraculous, thrilling, and humorous love story of this married couple, who manages to survive a crisis and stay together against all odds.`,
        cast: `Xu Kai, Cheng Xiao, Zhai Xiao Wen, Yao Chi, Rachel Wang, Zhou Yi Ran`,
        image: [`img/queen-of-tears.webp`, 
                `img/queen-of-tears2.webp`, 
                `img/queen-of-tears3.webp`],
    },
]

// --------*** MAP ***--------
const countries = [
    {
        name: "China",
        address: "",
        longitude: 103.66636812597092,
        latitude: 34.583158621304364,
    },
    {
        name: "Thailand",
        address: "",
        longitude: 100.992541,
        latitude: 15.870032,
    },
    {
        name: "South Korea",
        address: "",
        longitude: 127.766922,
        latitude: 35.907757,
    },
];

mapboxgl.accessToken = 'pk.eyJ1IjoiY2lhcmFuc2xvdyIsImEiOiJjbHY0ZW91YnYwOGV3MmlwOGQ5b3l3a3J3In0.EFWZEAWA13ehFAw5jdLqJA';

const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/streets-v11',
    center: [108.10959294178001, 18.40669244855137],
    zoom: 2
});

// Add markers to the map
countries.forEach(country => {
    const marker = new mapboxgl.Marker()
        .setLngLat([country.longitude, country.latitude])
        .setPopup(new mapboxgl.Popup({ offset: 25})
        .setHTML(`<h3>${country.name}</h3><p>${country.address}</p>`))
        .addTo(map);
});

// Function to fly to a country
function flyToCountry(countryName) {
    const country = countries.find(c => c.name === countryName);
    if (country) {
        map.flyTo({
            center: [country.longitude, country.latitude],
            essential: true,
            zoom: 4 // Adjust zoom level as needed
        });
    }
}


map.on('load', function() {
    map.resize();
});
// --------*** END of MAP ***--------

// Filter input elements
const countryFilter = document.getElementById("country");
const genreFilter = document.getElementById("genre");
const castFilter = document.getElementById("cast");
const sortSelect = document.getElementById("sort");
const clearFilter = document.getElementById("clear-filter-btn");

// Event listeners for filters
countryFilter.addEventListener("change", function() {
    const selectedCountry = countryFilter.value;
    flyToCountry(selectedCountry);
    filterAndPopulateResults();
});
genreFilter.addEventListener("change", filterAndPopulateResults);
castFilter.addEventListener("change", filterAndPopulateResults);

// Event listener for sorting
sortSelect.addEventListener("change", function () {
    const filteredDramas = filterCards();
    const sortedDramas = sortCards(filteredDramas, sortSelect.value);
    populateResults(sortedDramas);
});

// Event listener for clear button
clearFilter.addEventListener("click", resetFiltersAndSorting);

// ------****** FILTER FUNCTIONS *****-------
function filterCards() {
    return asianDramas.filter(drama => {

        // Check if country matches
        if (countryFilter.value && !drama.country.toLowerCase().includes(countryFilter.value.toLowerCase())) {
            return false;
        }

        // Check if genre matches
        if (genreFilter.value && !drama.genres.toLowerCase().includes(genreFilter.value.toLowerCase())) {
            return false;
        }
        
        // check if cast matches
        if (castFilter.value && !drama.cast.toLowerCase().includes(castFilter.value.toLowerCase())) {
            return false;
        }
        return true;
    });
}

// -------- **** SORTING FUNCTIONS ***** ---------
function sortCards(dramas, sortBy) {
    switch (sortBy) {
        // Sort A - Z 
        case 'A-Z':
            return dramas.sort((a, b) => a.name.localeCompare(b.name));
        // Sort By Country
        case 'country':
            return dramas.sort((a, b) => a.country.localeCompare(b.country));
        // Sort By Year
        case 'year':
            return dramas.sort((a, b) => a.year - b.year); // Sort by year in descending order
        default:
            return dramas;
    }
}

// -------- **** CLEAR FUNCTIONS ***** ---------
function resetFiltersAndSorting() {
    // Filters
    countryFilter.value = '';
    genreFilter.value = '';
    castFilter.value = '';
    // Sorting
    sortSelect.value = 'default';
    filterAndPopulateResults();
}

// -------***** POPULATION FUNCTIONS ****---------
// Filter and then Populate Results
function filterAndPopulateResults() {
    const filteredDramas = filterCards();
    console.log("Dramas Filtered:", filteredDramas);
    const sortedDramas = sortCards(filteredDramas, sortSelect.value);
    console.log("Sorted Dramas:", sortedDramas);

    populateResults(filteredDramas);

}

// Population of cards
filterAndPopulateResults();

function populateResults(filteredResults) {
    const cardContainer = document.getElementsByClassName('card-container')[0];
    cardContainer.innerHTML = "";

    if (filteredResults.length === 0) {
        cardContainer.innerHTML = `<p class="no-results">No Results Found</p>`;
    } else {
        filteredResults.forEach(drama => {
            const dramaCardHTML = `
                <div class="card">
                    <div class="swiper">
                        <!-- Additional required wrapper -->
                        <div class="swiper-wrapper">
                            <!-- Slides -->
                            ${drama.image.map(img => `
                                <div class="swiper-slide">
                                    <img src="${img}" alt="${drama.name}" class="drama-image">
                                </div>
                            `).join('')}
                        </div>
                        <div class="swiper-pagination"></div>
                        <div class="swiper-navigation"></div>
                    </div>
                    <div class="card-details">
                        <h2>${drama.name}</h2>
                        <h3>${drama.year}</h3>
                        <h3>Genres:</h3>
                        <p>${drama.genres}</p>
                        <h4>Cast:</h4>
                        <h5>${drama.cast}</h5>
                    </div>
                </div>
            `;
            cardContainer.innerHTML += dramaCardHTML;
        });

        attachModalToCards();

        // Re-initialize Swiper Instances
        const swipers = document.querySelectorAll('.swiper');
        swipers.forEach(swiperEl => {
            new Swiper(swiperEl, {
                direction: 'vertical',
                loop: true,
                autoplay: {
                    delay: 3500,
                    disableOnInteraction: false,
                },
                pagination: {
                    el: '.swiper-pagination',
                    clickable: true,
                },
                navigation: {
                    nextEl: '.swiper-button-next',
                    prevEl: '.swiper-button-prev',
                },
                loop: true,
            });
        });
    }
}

function attachModalToCards() {
    const cards = document.querySelectorAll('.card');
    const detailsModal = document.getElementById('details-modal');

    console.log("Cards found:", cards);

    cards.forEach((card, index) => {
        card.addEventListener('click', function() {
            populateModal(index);
            detailsModal.showModal();
            document.body.classList.add('modal-open');
            console.log("Cards modal opened");

        });
    });

    document.getElementById('close-modal').addEventListener('click', function() {
        console.log("Close modal button clicked.");
        detailsModal.close();
        document.body.classList.remove('modal-open');
    });
}

function populateModal(index) {
    const modalContents = document.querySelector('.modal-contents');
    const drama = asianDramas[index];

    modalContents.innerHTML = `
        <div class="swiper">
            <div class="swiper-wrapper">
                ${drama.image.map(img => `
                    <div class="swiper-slide">
                        <img src="${img}" alt="${drama.name}">
                    </div>
                `).join('')}
            </div>
            <div class="swiper-pagination"></div>
            <div class="swiper-navigation"></div>
        </div>
        <div class="modal-text">
            <h2>${drama.name}</h2>
            <h3>${drama.year}</h3>
            <h3>Genres:</h3>
            <p>${drama.genres}</p>
            <h3>Bio:</h3>
            <p>${drama.description}</p>
            <h4>Cast:</h4>
            <h5>${drama.cast}</h5>
        </div>
    `;

    // Reinitialize the Swiper for the modal
    new Swiper('.swiper', {
        direction: 'vertical',
        loop: true,
        autoplay: {
            delay: 3500,
            disableOnInteraction: false,
        },
        pagination: {
            el: '.swiper-pagination',
            clickable: true,
        },
        navigation: {
            nextEl: '.swiper-button-next',
            prevEl: '.swiper-button-prev',
        },
    });
}

function closeDetailsModal() {
    const close = document.getElementById('close-modal');
    const detailsModal = document.getElementById('details-modal');

    close.addEventListener('click', function() {
        detailsModal.close();
        document.body.classList.remove('modal-open');
        const scrollPosition = detailsModal.dataset.scrollPosition || 0;
        window.scrollTo(0, scrollPosition);
    });
}

// --------******* SWIPER JS ******-------
const swiper = new Swiper('.swiper', {
    // Optional parameters
    direction: 'vertical',
    loop: true,
    autoplay: {
        delay: 3500,
        disableOnInteraction: false,
    },
    // If we need pagination
    pagination: {
      el: '.swiper-pagination',
      clickable: true, // enable clickable pagination bullets
    },
});
